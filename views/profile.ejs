<html>
<% include header %>

<style type="text/css">
	.right-panel { border-right: 1px solid #999; height:100%; background-color:#eee;}
	.right-panel h2 {color:#ccc;}
	.our_form .input-group {margin-top:5px;}
</style>


<!-- Event Management -->
<form action="/addevent" method="post" class="our_form">
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Event</h4>
      </div>
      <div class="modal-body">
		<% include form_event %>


      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <input class="btn btn-primary" type="submit" value="Save">
        
      </div>
    </div>
  </div>
</div>
</form>


<!-- Event Management -->
<form action="/updatecontacts" method="post" class="our_form">
<div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel2" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel2">Emergency Contacts</h4>
      </div>
      <div class="modal-body">
		<% include edit_contacts %>


      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <input class="btn btn-primary" type="submit" value="Save">
        
      </div>
    </div>
  </div>
</div>
</form>


<%
var username = 'Undefined User';
if (user.local.name) { 
	username = user.local.name;
} else if (user.facebook.name) {
	username = user.facebook.name;
}
console.log(username);
%>


<div class="container-fluid">
<div class="row">
<div class="col-sm-2 right-panel">
	
	<h2> Welcome <%=username%> </h2>
	<h4> Contacts</h4>
	<% 
	var lovedemail = "No email entered";
	var nursemail = "No email entered";
	if (user.lovedonemail) {
		lovedemail = user.lovedonemail;
	}
	if (user.nursemail) {
		nursemail = user.nursemail;
	}
	%> 
	<p> Loved one: <%=lovedemail%></p>
	<p> Nurse: <%=nursemail%></p>
	<button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal2"
						data-goal=""
						data-goal-id="-1"
						data-category=""
>
  	Edit Contacts
	</button>

<button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal"
						data-goal=""
						data-goal-id="-1"
						data-category=""
>
  New Event
</button>

</div>
<div class="col-sm-10">

	<% if (user.events.length > 0) { %>
		<table class="table table-hover"> 
			<thead> <tr> 
				<th> Goal List </th> <th> Yesterday </th> <th> Today </th> 
			</tr> </thead>
			<tbody>
			<% for (var e in user.events){ 
				if (user.events[e].title){	
					if (user.events[e].dateEnd === undefined){
					%>
				<tr>

					<td><a class="details" data-toggle="modal" data-target="#myModal" 
						data-goal="<%=user.events[e].title%>"
						data-goal-id="<%=user.events[e]._id%>"
						data-category="<%=user.events[e].category%>"
						>
					<%=user.events[e].title%>
					</a></td> 
					<td>
					<%
					var c = new Date();
					c.setHours(0);
					c.setMinutes(0);
					c.setSeconds(0);
					c.setMilliseconds(0);
					var y = new Date(c.getTime());
					y.setDate(c.getDate()-1)
					var yesterday = user.events[e].compliance_history.filter(
						function(hist){
							return hist.date_event < c & hist.date_event >= y;
						}
					);
					var today = user.events[e].compliance_history.filter(
						function(hist){
							return hist.date_event >= c;
						}
					);
					if (yesterday.length > 0 & yesterday.has_complied){
						%> <input class="yesterday_checkbox" type="checkbox" disabled readonly checked> <%
					} else {
						%> <input class="yesterday_checkbox" type="checkbox" disabled readonly> <%
					}
					%>
					</td>
					<td>
					<%
					if (today.length > 0 & !today.has_complied){
						%> <input class="today_checkbox" type="checkbox" id="<%=user.events[e]._id%>" checked> <%
					} else {
						%> <input class="today_checkbox" type="checkbox" id="<%=user.events[e]._id%>"><%
					}
					%>
					</td>
				</tr>
			<% 		}
				}
			} %>
			</tbody>
		</table>
	<%
	} else { %>
		No events yet! Add a new event below.
	<% } 
	var events = [];
	for (var e in user.events){
		if (e<user.events.length){
			events.push(user.events[e].title);
		}
	}
	%>




<% include kitten %>
<input id="secretvoice" type="button" onclick="customDialogue('<%=username%>','<%=JSON.stringify(events)%>'');"/>

<Script>

$('#myModal').on('show.bs.modal', function (event) {
  var button = $(event.relatedTarget) // Button that triggered the modal
  var goal = button.data('goal') // Extract info from data-* attributes
  var id = button.data('goal-id') // Extract info from data-* attributes
  var category = button.data('category') // Extract info from data-* attributes
  // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
  // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
  var modal = $(this)
  modal.find('#eventtitle').val( goal )
  modal.find('#category').val( category )
  modal.find('#goal-id').val( id )


})


// Do we need to display reward?  Sohuld return true if the user just complied with everything
// May be true when 
// 1.  loaded from email after the user checked off the last item or
// 2.  user checks off the last item via web interface


function need_to_display_reward()
{
	return $(".today_checkbox").length - $(".today_checkbox:checked").length == 0;
}

function try_to_display_reward()
{
	if( need_to_display_reward() )
		display_kitten();
}

$(':checkbox').click(function() {
    // $this will contain a reference to the checkbox
	$.ajax({
		type: 'POST',
		url: '/checkevent',
		data: {
			eventid: this.id
		}
	});
	$(".today_checkbox:checked").replaceWith( '<span class="label label-success">:)</span>' );
	try_to_display_reward();
});

$(function(){
	$(".yesterday_checkbox:not(:checked)").replaceWith( '<span class="label label-danger">:(</span>' );
	$(".today_checkbox:checked").replaceWith( '<span class="label label-success">:)</span>' );
});

function customDialogue(username, eventList){
	eventList = JSON.parse(eventList);
    var wsr = new webkitSpeechRecognition();
    wsr.start();

    deflang = "en.UK";
    defpitch = 1.4;
    defrate = 1.4; 
    
    var msg = new SpeechSynthesisUtterance();
    msg.text = "Hi "+username+", how're you doing today?";
    msg.lang = deflang;
    msg.pitch = defpitch;
    msg.rate = defrate;

    var responses = [];

    for (var e in eventList){
        var goalname = eventList[e];
        var prevMood = "OK. ";
        if (goalname) {
        	console.log(goalname);
            msg.onend = function(e) {
              wsr.start();
            };
			wsr = new webkitSpeechRecognition();
            
            msg = new SpeechSynthesisUtterance();
            msg.text = prevMood + "How have you been doing with goal "+e.toString()+": "+goalname+"?";
            msg.lang = deflang;
            msg.pitch = defpitch;
            msg.rate = defrate;
            wsr.onend = function(e) {
                window.speechSynthesis.speak(msg); 
            }
            // right now assume answers are yes, todo process response
            responses.push(1);
            prevMood = "Great!";
         }

    }

    if (responses.length > 0){
      	if (responses.reduce(function(a,b) {return a+b;} ) == responses.length){
	        msg.onend = function(e) {
	            appledropper();
	        }        
    	}
    }
    return responses;
}

// $('#secretvoice').click(function() {
// 	var $this = $(this);
// 	var username = this.username;
// 	var events = this.events;
// 	console.log(this);
// 	var r = customDialogue(username, events);
// });

</script>

<% include ga %>
</html>